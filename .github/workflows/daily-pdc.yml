
name: Daily PDC

on:
  # Manually run from Actions tab
  workflow_dispatch:

  # Nightly (03:00 UTC). Adjust as needed.
  schedule:
    - cron: '0 3 * * *'

  # Triggered by Lab/Service/OS repos via repository_dispatch
  repository_dispatch:
    types: [pdc-compose]

# Needed if you push tags/releases from the workflow
permissions:
  contents: write

# Customize these to your org/repo names and workflow/artifact names in the upstream repos
env:
  LAB_REPO: balaji-kadri/lab-workflow
  LAB_WORKFLOW: build.yml
  LAB_ARTIFACT: lab-artifact

  SERVICE_REPO: balaji-kadri/service-workflow
  SERVICE_WORKFLOW: build.yml
  SERVICE_ARTIFACT: service-artifact

  OS_REPO: balaji-kadri/os-workflow
  OS_WORKFLOW: build.yml
  OS_ARTIFACT: os-artifact

  # Optional perf budget used by run_perf.py
  PERF_BUDGET: "0.10"

concurrency:
  group: daily-pdc-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PDC repo
        uses: actions/checkout@v4
        with:
          # Ensure tags/history available for release tagging
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare inputs folder
        run: mkdir -p inputs

      # Download artifacts from Lab/Service/OS repositories (requires PAT with contents:read on those repos)
      - name: Download Lab artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PDC_DISPATCH_TOKEN }}
          repo: ${{ env.LAB_REPO }}
          workflow: ${{ env.LAB_WORKFLOW }}
          name: ${{ env.LAB_ARTIFACT }}
          path: inputs

      - name: Download Service artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PDC_DISPATCH_TOKEN }}
          repo: ${{ env.SERVICE_REPO }}
          workflow: ${{ env.SERVICE_WORKFLOW }}
          name: ${{ env.SERVICE_ARTIFACT }}
          path: inputs

      - name: Download OS artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PDC_DISPATCH_TOKEN }}
          repo: ${{ env.OS_REPO }}
          workflow: ${{ env.OS_WORKFLOW }}
          name: ${{ env.OS_ARTIFACT }}
          path: inputs

      - name: Normalize filenames (if artifacts landed in subfolders)
        shell: bash
        run: |
          set -euo pipefail
          # Move lab.json/service.json/os.json to inputs root if nested
          if [ -f "inputs/${LAB_ARTIFACT}/lab.json" ]; then mv "inputs/${LAB_ARTIFACT}/lab.json" inputs/lab.json; fi
          if [ -f "inputs/${SERVICE_ARTIFACT}/service.json" ]; then mv "inputs/${SERVICE_ARTIFACT}/service.json" inputs/service.json; fi
          if [ -f "inputs/${OS_ARTIFACT}/os.json" ]; then mv "inputs/${OS_ARTIFACT}/os.json" inputs/os.json; fi
          echo "Inputs directory:"
          ls -la inputs

          # Fail fast if any required input missing
          for f in inputs/lab.json inputs/service.json inputs/os.json; do
            [ -f "$f" ] || { echo "❌ Missing $f. Verify upstream artifacts and names."; exit 2; }
          done

      - name: Compose PDC
        run: |
          python3 scripts/compose_pdc.py \
            --lab inputs/lab.json \
            --service inputs/service.json \
            --os inputs/os.json

      - name: Upload composed artifact (for debugging/audit)
        uses: actions/upload-artifact@v4
        with:
          name: pdc-composed
          path: dist/pdc.json

  test_and_gate:
    runs-on: ubuntu-latest
    needs: compose
    steps:
      - name: Checkout PDC repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate test reports
        run: |
          python3 scripts/run_e2e.py --report reports/e2e.json
          python3 scripts/run_perf.py --budget "${{ env.PERF_BUDGET }}" --report reports/perf.json
          python3 scripts/run_security.py --report reports/security.json
          python3 scripts/run_coverage.py --report reports/coverage.json

      - name: Verify reports exist
        run: |
          ls -la reports || { echo "reports/ missing"; exit 1; }
          for f in coverage.json e2e.json perf.json security.json; do
            [ -f "reports/$f" ] || { echo "❌ Missing reports/$f"; exit 2; }
          done
          echo "✅ All reports present."

      - name: Gate on results (reject if policy violated)
        run: |
          python3 scripts/gate.py \
            --coverage reports/coverage.json \
            --e2e reports/e2e.json \
            --perf reports/perf.json \
            --security reports/security.json \
            --policy policies/pdc_policy.json

      - name: Upload test reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: pdc-test-reports
          path: reports

  release:
    runs-on: ubuntu-latest
    needs: test_and_gate
    if: ${{ needs.test_and_gate.result == 'success' }}
    steps:
      - name: Checkout PDC repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Bring reports from previous job into this job's workspace
      - name: Download test reports
        uses: actions/download-artifact@v4
        with:
          name: pdc-test-reports
          path: reports

      - name: Configure Git (tagging)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Tag Release
        run: |
          TAG="pdc-$(date +'%Y.%m.%d')-build${{ github.run_number }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag -a "$TAG" -m "Daily PDC release"
          git push origin "$TAG"
          echo "✅ Pushed tag: $TAG"

      # Harden emit step: will succeed even if a report is missing (your script can log defaults)
      - name: Emit dashboard payload
        run: |
          python3 scripts/emit_dashboard.py \
            --tag "$TAG" \
            --commit "${{ github.sha }}" \
            --reports reports \
            --out dashboard/payload.json

      - name: Upload dashboard payload
        uses: actions/upload-artifact@v4
        with:
          name: pdc-dashboard-payload
          path: dashboard/payload.json
      
      - name: Prepare dashboard site
        run: |
          mkdir -p dashboard-site
          cp dashboard/payload.json dashboard-site/payload.json
          # Copy index.html, style.css, script.js from repo (already committed)
          cp dashboard-site/* dashboard-site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dashboard-site
          publish_branch: gh-pages

